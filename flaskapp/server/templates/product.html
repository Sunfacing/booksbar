<!DOCTYPE html>
<html lang="en">
    <head>
      <title>Booksbar | {{kingstone['title']}}</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="icon" href="https://d3bu8utwyaxpsl.cloudfront.net/open-book.png">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
        <link rel="stylesheet" href="{{ url_for('static', filename='css/product.css') }}">
        <script type="text/javascript" src="{{ url_for('static', filename='js/product.js', u=last_updated) }}"></script>
      </head>
    <body>
      <nav class="navbar">
        <a class="navbar-brand" href="{{ url_for('index')}}"><img class="navbarlogo" src='https://d3bu8utwyaxpsl.cloudfront.net/logo.png'></a>
        {% if 'loggedin' in session %}
          <a href="/member"><i class="fas fa-user-circle fa-2x"></i></a>        
        {% else %}
          <a onclick="document.getElementById('id01').style.display='block'" ><i class="fas fa-user-circle fa-2x"></i></a>
        {% endif %}
        {% include 'login.html' %}
      </nav>
        <div id="mySidenav" class="sidenav">
          <a class="navbar-brand"><img src='https://dewey.tailorbrands.com/production/brand_version_mockup_image/380/6391619380_b1cf68eb-1598-4eb2-987f-bd1ab6196133.png?cb=1637199110' style="width: 100%;"></a>
          <a href="javascript:void(0)" class="closebtn"onclick="closeNav()">&times;</a>
          {% for each in nav_sec%}
            <a class="seclink" href="/{{ each }}"><h5 class="section_nav">{{each}}</h5></a>
          {% endfor %}
        </div>
        <div class="divider">
        </div>
        <span class="navbtn btn my-2 my-sm-0" href="#" role="button" onclick="openNav()">分<br>類<br>表</span>
        <div class="row  w3-animate-opacity ">
          <div class="container col-sm-2"></div>
          <div class="container col-sm-8 upper">
            <ul class="breadcrumb bg-light">
              <li class="subtitle">分類: </li>
              <li><a class="catelink" href="/{{kingstone['section']}}">{{kingstone['section']}}</a></li>
              <li style="margin-right: 10px;"><i class="fas fa-angle-double-right""></i></li>
              <li><a class="catelink" href="/{{kingstone['section']}}?category_nm={{kingstone['category']}}">{{kingstone['category']}}</a></li>
              <li style="margin-right: 10px;"><i class="fas fa-angle-double-right"></i></li>
              <li><a class="catelink" href="/{{kingstone['section']}}?category_nm={{kingstone['category']}}&subcate_nm={{kingstone['subcategory']}}">{{kingstone['subcategory']}}</a></li>
            </ul>       
          </div>  
          <div class="container col-sm-2"></div>
          
        </div>
        <div class="row  w3-animate-opacity ">
          <div class="container col-sm-2"></div>
          <div class="container col">
            <div id="demo" class="carousel slide" data-ride="carousel">
              <!-- Indicators -->
              <ul class="carousel-indicators ">
                <li data-target="#demo" data-slide-to="0" class="active"></li>
                {% for pic in pic_list %}
                <li data-target="#demo" data-slide-to="{{ pic[1] }}"></li>
                {% endfor %}
              </ul> 
              <!-- The slideshow -->
              <div class="carousel-inner "  >
                <div class="carousel-item active">
                  <img class="zoom " src="{{kingstone['cover_photo']}}" alt="" width="100%" height="100%" onerror="this.onerror=null;this.src='https://dewey.tailorbrands.com/production/brand_version_mockup_image/674/6392009674_d59d0209-6c03-4b75-9084-0e5fffb34183.png?cb=1637205240'">
                </div>
                {% for pic in pic_list %}
                <div class="carousel-item ">
                  <img class="zoom " src="{{ pic[0] }}" alt="Chicago" width="100%" height="100%" >
                </div>
                {% endfor %}
                <!-- Left and right controls -->
                <a class="carousel-control-prev" href="#demo" data-slide="prev""> 
                  <span class="carousel-control-prev-icon bg-dark" ></span>
                </a>
                <a class="carousel-control-next" href="#demo" data-slide="next">
                  <span class="carousel-control-next-icon bg-dark"></span>
                </a>
              </div>
            </div>
          </div>
          <div class="container col">
            <div class="row title">
              <h4>{{kingstone['title']}}</h4>
            </div>
            <div class="row info">
              <div>
              <a href="/keyword?search={{kingstone['author']}}&only_author=True" style="text-decoration: none;  color: #393d3f;"><h5 style="font-size: medium; font-weight: bold; color: #393d3f;">作者: {{kingstone['author']}}  <i class="fas fa-search" style="color:#E34234"></i></h5></a>
              <h5 class="info">出版社: {{kingstone['publisher']}}</h5>
              <h5 class="info">出版日: {{kingstone['publish_date']}}</h5>
              <h5 class="info">ISBN: {{kingstone['ISBN']}}</h5>
              <h5 class="info">頁數: {{kingstone['page']}}</h5>
              <h5 class="info">尺寸: {{kingstone['size']}}</h5>
              </div>
            </div>
            <div class="row price">
              <div class="container col-3 price">
                <img class="brandlogo" src="https://linepaytw-cms.line-scdn.net/v0/fc8cb09e193cc3f5a8e7ebc6910debd296aacb3d84e1f1a2891dd45444a03855.png" >
                {% if kingstone['price'] > 0 %} 
                  <h4 class="price available">{{kingstone['price']}} 元</h4><a href="{{kingstone['product_url']}}" class="btn available">前往網站</a>
                {% else %}
                  <h4 class="price out-of-stock">{{kingstone['price']}}</h4><button type="button" class="btn btn-default out-of-stock">暫無存貨</button>
                {% endif %}
              </div>

              <div class="container col-4 price">
                <img class="brandlogo" src="https://meet.eslite.com/Content/Images/ThemePavilion/eslite-logo.jpg">
                {% if eslite['price'] > 0 %}  
                  <h4 class="price available">{{eslite['price']}} 元</h4><a href="{{eslite['product_url']}}" class="btn available">前往網站</a>
                {% else %}
                  <h4 class="price out-of-stock">{{eslite['price']}}</h4><button type="button" class="btn btn-default out-of-stock">暫無存貨</button>
                {% endif %}
              </div>
              
              <div class="container col-3">
                <img class="brandlogo" src="https://www.esunbank.com.tw/bank/-/media/esunbank-mobile/images/discount/shops/b_onlineshop/2008.jpg" >
                {% if momo['price'] > 0 %}                              
                  <h4 class="price available">{{momo['price']}} 元</h4><a href="{{momo['product_url']}}" class="btn available">前往網站</a>
                {% else %}
                  <h4 class="price out-of-stock">{{momo['price']}}</h4><button type="button" class="btn btn-default out-of-stock">暫無存貨</button>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="container col-sm-2 track" id='tracker'>
            <div class="divider track">
              {% if tracking_hash[1] %}
                <button type="button" class="btn btn-check row" id="subcategory" value="?subcate={{kingstone['category_id']}}" onclick="add_to_favorite()"><i class="fas fa-heart on" id="heart"> 追蹤分類 - {{kingstone['subcategory']}}</i></button>
              {% else %}
                <button type="button" class="btn btn-basic row" id="subcategory" value="?subcate={{kingstone['category_id']}}" onclick="add_to_favorite()"><i class="fas fa-heart off" id="heart"> 追蹤分類 - {{kingstone['subcategory']}}</i></button>
              {% endif %}
            </div>
            <div class="divider track">
              {% if tracking_hash[3] %}
                <button type="button" class="btn btn-check row" value="?author={{kingstone['author_id']}}" onclick="cancel_favorite()"><i class="fas fa-pen-nib on"> 追蹤作者</i></button>
              {% else %}  
                <button type="button" class="btn btn-basic row" value="?author={{kingstone['author_id']}}" onclick="cancel_favorite()"><i class="fas fa-pen-nib off"> 追蹤作者</i></button>
              {% endif %}  
            </div>
           <div class="divider track">
            {% if tracking_hash[2] %}
              <button type="button" class="btn btn-check row" value="?price={{kingstone['isbn_id']}}" onclick="add_to_favorit()"><i class="fas fa-tag on"> 追蹤本書</i></button>
            {% else %}  
              <button type="button" class="btn btn-basic row" value="?price={{kingstone['isbn_id']}}" onclick="add_to_favorit()"><i class="fas fa-tag off"> 追蹤本書</i></button>
            {% endif %}  
          </div>
          </div>
        </div>  
        <div class="container col-sm-8 w3-animate-opacity info">
          <div id="naver">
          <ul  class="nav nav-pills navbar navbar-expand-sm bg-light">
            <li><a data-toggle="pill" href="#table_of_content" class="btn active">目錄大綱</a></li>
            <li><a data-toggle="pill" href="#description" class="btn">內容簡介</a></li>
            <li><a data-toggle="pill" href="#author_intro" class="btn">作者介紹</a></li>
            <li><a data-toggle="pill" href="#comment" class="btn">讀者評論</a></li>
          </ul>
        </div>
          <div class="tab-content">
            <div id="table_of_content" class="tab-pane fade in active"> 
            </div>
            <div id="description" class="tab-pane fade">
            </div>
            <div id="author_intro" class="tab-pane fade">
            </div>
            <div id="comment" class="tab-pane fade">
              {% if comment_list | length == 0%}
                  <p> 目前尚無評論 </p>
              {% else %}
              {% for each in comment_list %}
                <div class="usercomment">
                  {{ each[0] }}
                  <p>{{ each[1][1:-1] }}</p>
                </div>
              {% endfor %}
              {% endif %}

            </div>
          </div>
        </div> 
        <script>
          fetch("/api/product/bookinfo/{{kingstone['isbn_id']}}")
              .then(response => response.json())
              .then(render)
        </script>        
    </body>
    <script>
      var tracker = document.getElementById('tracker')
      let button_tag;
      let icon_tag;
      tracker.addEventListener('click', (e) => {
        if (e.target.tagName == 'I') {
          icon_tag = e.target;
          button_tag = e.target.parentNode;
          value = e.target.parentNode.value;
        } else if (e.target.tagName == 'BUTTON') {
          button_tag = e.target;
          icon_tag = e.target.firstChild;
          value = e.target.value;
        } else {
          value = 0;
        }
        if ( value != 0) {
          var api = "/api/favorite"+ value;
          let request_method = 'POST';
          if (button_tag.className == 'btn btn-check row') {
            request_method = 'DELETE';
          }

        fetch(api, {method: request_method})
              .then(response => response.json())
              .then(set_favorite)}
      })


      function set_favorite(result) {
          if (result.message == 'added') {
            button_tag.className = button_tag.className.replace("btn-basic", "btn-check");
            icon_tag.style.color = "#ffffff"
          } else if ( result.message == 'cancelled') {
            button_tag.className = button_tag.className.replace("btn-check", "btn-basic");
            icon_tag.style.color = "#393d3f"                  
          } else {
            document.getElementById('id01').style.display='block'
          }
      }
    </script>
</html>